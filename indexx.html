<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAP Value Bridge - Joule Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Ajustes finos para que parezca una app nativa */
      body {
        background-color: #f1f5f9;
        font-family: "Segoe UI", sans-serif;
      }
      .slider-thumb::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #2563eb;
        border-radius: 50%;
        cursor: pointer;
      }
      .glass-panel {
        background: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border-radius: 1rem;
      }
      /* ESTILO PARA EL BLUR Y EL OVERLAY */
      .blur-content {
        filter: blur(8px);
        pointer-events: none; /* Evita interacciones mientras est√° borroso */
        opacity: 0.5;
        transition: all 0.5s ease;
      }
      .content-visible {
        filter: blur(0);
        opacity: 1;
        pointer-events: auto;
      }
      .overlay-email {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 20; /* Asegura que est√© por encima del contenido borroso */
        display: flex;
        align-items: center;
        justify-content: center;
        /* Estilo sutil de fondo para el overlay */
        background-color: rgba(241, 245, 249, 0.8); 
        backdrop-filter: blur(4px);
        border-radius: 1rem;
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="text-slate-800 p-4 md:p-8">
    <div
      class="max-w-6xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4"
    >
      <div class="flex items-center gap-3">
        <div class="bg-blue-900 p-3 rounded-lg text-white">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="4" y="2" width="16" height="20" rx="2" />
            <line x1="8" y1="6" x2="16" y2="6" />
            <line x1="16" y1="14" x2="16" y2="14" />
            <line x1="8" y1="14" x2="8" y2="14" />
            <line x1="12" y1="14" x2="12" y2="14" />
            <line x1="16" y1="18" x2="16" y2="18" />
            <line x1="8" y1="18" x2="8" y2="18" />
            <line x1="12" y1="18" x2="12" y2="18" />
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-slate-900">SAP Value Bridge</h1>
          <p class="text-sm text-slate-500 font-medium">
            ROI Calculator ‚Ä¢ Joule Base Edition
          </p>
        </div>
      </div>
      <div class="text-right">
        <p class="text-xs text-slate-400 uppercase tracking-wider">
          Validado con
        </p>
        <p class="text-sm font-bold text-blue-800">
          SAP Discovery Center Metrics
        </p>
      </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Columna Izquierda: Inputs -->
      <div class="lg:col-span-4 space-y-6">
        <div class="glass-panel p-6">
          <h2 class="text-lg font-semibold mb-6 flex items-center gap-2">
            <span class="w-1 h-6 bg-blue-600 rounded-full"></span>
            Datos del Cliente
          </h2>

          <div class="mb-6">
            <div class="flex justify-between mb-2">
              <label class="text-sm font-medium text-slate-600"
                >Usuarios SAP</label
              >
              <span
                id="displayUsers"
                class="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded"
                >50</span
              >
            </div>
            <input
              type="range"
              id="inputUsers"
              min="10"
              max="500"
              step="10"
              value="50"
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <div class="mb-6">
            <div class="flex justify-between mb-2">
              <label class="text-sm font-medium text-slate-600"
                >Coste Empleado / A√±o</label
              >
              <span id="displaySalary" class="text-sm font-bold text-slate-700"
                >35.000 ‚Ç¨</span
              >
            </div>
            <input
              type="range"
              id="inputSalary"
              min="20000"
              max="80000"
              step="1000"
              value="35000"
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
            />
          </div>

          <div class="mb-6">
            <div class="flex justify-between mb-2">
              <label class="text-sm font-medium text-slate-600"
                >Tiempo diario en SAP</label
              >
              <span
                id="displayIntensity"
                class="text-sm font-bold text-slate-700"
                >40%</span
              >
            </div>
            <input
              type="range"
              id="inputIntensity"
              min="10"
              max="80"
              step="5"
              value="40"
              class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
            />
            <p class="text-xs text-slate-400 mt-1">
              Estimaci√≥n de uso del ERP.
            </p>
          </div>

          <div class="pt-4 border-t border-slate-100">
            <label class="text-sm font-bold text-slate-800 mb-2 block"
              >Inversi√≥n Servicios (Consultor√≠a)
            </label>
            <div class="relative">
              <span class="absolute left-3 top-2 text-slate-400">‚Ç¨</span>
              <input
                type="number"
                id="inputCost"
                value="5000"
                class="w-full pl-8 pr-4 py-2 border border-slate-200 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
            <p class="text-xs text-green-600 mt-1 font-medium">
              ‚úì Licencia Joule: Incluida (0‚Ç¨)
            </p>
          </div>
        </div>

        <div class="bg-slate-200 p-4 rounded-xl border border-slate-300">
          <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">
            M√©tricas Oficiales SAP
          </h3>
          <div class="space-y-2 text-sm text-slate-700">
            <div class="flex items-center gap-2">
              <span class="text-green-600 font-bold">‚úì</span> 95% Faster Search
            </div>
            <div class="flex items-center gap-2">
              <span class="text-green-600 font-bold">‚úì</span> 90% Faster
              Navigation
            </div>
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Resultados -->
      <div class="lg:col-span-8 space-y-6 relative" id="resultsColumn">
        
        <!-- Overlay para Email -->
        <div class="overlay-email" id="emailOverlay">
          <div
            class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center"
          >
            <h3 class="text-xl font-bold mb-2 text-slate-800">
              Desbloquea tu ROI
            </h3>
            <p class="text-sm text-slate-600 mb-6">
              Introduce tu email para ver el c√°lculo y recibir el informe completo.
            </p>

            <input
              type="email"
              id="clientEmail"
              placeholder="tu.correo@empresa.com"
              class="w-full px-4 py-3 mb-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-colors"
            />
            <p id="emailError" class="text-red-500 text-xs mb-3 hidden">
                Por favor, introduce un email v√°lido.
            </p>
            <button
              id="btnUnlock"
              onclick="unlockResults()"
              class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-bold text-sm transition text-white shadow-lg shadow-blue-500/50 flex items-center justify-center gap-2"
            >
              Mostrar Resultados
            </button>
          </div>
        </div>

        <!-- Contenido de Resultados (con blur inicial) -->
        <div id="resultsContent" class="blur-content">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass-panel p-6 border-l-4 border-emerald-500">
              <span class="text-xs font-bold text-slate-500 uppercase"
                >Ahorro Anual</span
              >
              <div
                id="valSavings"
                class="text-3xl font-bold text-emerald-600 mt-1"
              >
                0 ‚Ç¨
              </div>
              <p class="text-xs text-slate-400 mt-1">Productividad recuperada</p>
            </div>
            <div class="glass-panel p-6 border-l-4 border-blue-500">
              <span class="text-xs font-bold text-slate-500 uppercase"
                >ROI Proyecto</span
              >
              <div id="valRoi" class="text-3xl font-bold text-blue-600 mt-1">
                0 %
              </div>
              <p class="text-xs text-slate-400 mt-1">Retorno Inversi√≥n</p>
            </div>
            <div class="glass-panel p-6 border-l-4 border-purple-500">
              <span class="text-xs font-bold text-slate-500 uppercase"
                >Payback Time</span
              >
              <div
                id="valPayback"
                class="text-3xl font-bold text-purple-600 mt-1"
              >
                0 Meses
              </div>
              <p class="text-xs text-slate-400 mt-1">Tiempo para rentabilizar</p>
            </div>
          </div>

          <div class="glass-panel p-6 h-80 relative">
            <h3
              class="text-sm font-bold text-slate-700 mb-4 absolute top-6 left-6"
            >
              Proyecci√≥n Financiera (12 Meses)
            </h3>
            <canvas id="roiChart"></canvas>
          </div>

          <!-- Footer con Feedback -->
          <div class="bg-slate-900 text-white p-4 rounded-xl flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-sm">
              <span class="font-bold text-blue-400">Nota:</span> C√°lculos
              basados en eficiencia operativa est√°ndar.
            </div>
            
            <!-- Contenedor de Feedback -->
            <div id="feedbackContainer" class="flex items-center gap-4 bg-slate-800/50 px-4 py-2 rounded-lg">
                
                <!-- Estado Inicial: Botones -->
                <div id="feedbackButtons" class="flex items-center gap-4">
                    <span class="text-sm font-bold text-slate-200">¬°Danos tu opini√≥n!</span>
                    <div class="flex gap-2">
                        <button 
                            onclick="sendFeedback('like')"
                            class="p-2 hover:bg-slate-700 rounded-full transition-colors group"
                            title="Me gusta"
                        >
                            <svg class="w-6 h-6 text-slate-400 group-hover:text-green-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                            </svg>
                        </button>
                        <button 
                            onclick="sendFeedback('dislike')"
                            class="p-2 hover:bg-slate-700 rounded-full transition-colors group"
                            title="No me gusta"
                        >
                            <svg class="w-6 h-6 text-slate-400 group-hover:text-red-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Estado Cargando -->
                <div id="feedbackSending" class="hidden flex items-center gap-2 text-sm text-slate-300">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Enviando...
                </div>

                <!-- Estado Enviado -->
                <div id="feedbackSent" class="hidden flex items-center gap-2 text-sm font-bold text-green-400 animate-pulse">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    ¬°Gracias por tu opini√≥n!
                </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <script>
      // --- CONFIGURACI√ìN ---
      const CONSTANTS = {
        days: 220,
        hours: 8,
        navPercent: 0.2, // 20% del tiempo es navegaci√≥n
        jouleEff: 0.925, // (95% + 90%) / 2
      };

      // Variables Globales
      let isUnlocked = false;
      let userEmail = "";

      // --- ELEMENTOS DOM ---
      const inputs = {
        users: document.getElementById("inputUsers"),
        salary: document.getElementById("inputSalary"),
        intensity: document.getElementById("inputIntensity"),
        cost: document.getElementById("inputCost"),
      };

      const displays = {
        users: document.getElementById("displayUsers"),
        salary: document.getElementById("displaySalary"),
        intensity: document.getElementById("displayIntensity"),
        savings: document.getElementById("valSavings"),
        roi: document.getElementById("valRoi"),
        payback: document.getElementById("valPayback"),
      };
      
      const resultsContent = document.getElementById("resultsContent");
      const emailOverlay = document.getElementById("emailOverlay");
      const clientEmailInput = document.getElementById("clientEmail");
      const emailError = document.getElementById("emailError");
      const btnUnlock = document.getElementById("btnUnlock");

      // --- GR√ÅFICO CHART.JS ---
      const ctx = document.getElementById("roiChart").getContext("2d");
      let myChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [
            "Inicio",
            "Mes 2",
            "Mes 4",
            "Mes 6",
            "Mes 8",
            "Mes 10",
            "Mes 12",
          ],
          datasets: [
            {
              label: "Balance Acumulado (‚Ç¨)",
              data: [0, 0, 0, 0, 0, 0, 0],
              borderColor: "#10B981",
              backgroundColor: "rgba(16, 185, 129, 0.1)",
              borderWidth: 3,
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              grid: { color: "#f1f5f9" },
              ticks: { callback: (v) => v / 1000 + "k‚Ç¨" },
            },
            x: { grid: { display: false } },
          },
        },
      });

      // --- FUNCI√ìN PRINCIPAL DE C√ÅLCULO ---
      function calculate() {
        // 1. Leer valores
        const numUsers = parseInt(inputs.users.value);
        const avgSalary = parseInt(inputs.salary.value);
        const intensity = parseInt(inputs.intensity.value);
        const cost = parseInt(inputs.cost.value) || 0; // Evitar NaN

        // 2. Actualizar textos de los sliders
        displays.users.textContent = numUsers;
        displays.salary.textContent = avgSalary.toLocaleString() + " ‚Ç¨";
        displays.intensity.textContent = intensity + "%";
        
        // Si no se ha desbloqueado, no mostramos resultados financieros
        if (!isUnlocked) {
            return;
        }

        // 3. MATEM√ÅTICAS (CORE)
        const hourlyRate = avgSalary / (CONSTANTS.days * CONSTANTS.hours);
        // Horas totales en SAP * % Navegaci√≥n * % Eficiencia Joule
        const hoursSavedPerYear =
          numUsers *
          CONSTANTS.days *
          CONSTANTS.hours *
          (intensity / 100) *
          CONSTANTS.navPercent *
          CONSTANTS.jouleEff;

        const annualSavings = hoursSavedPerYear * hourlyRate;
        const monthlySavings = annualSavings / 12;

        const roi = cost === 0 ? 0 : ((annualSavings - cost) / cost) * 100;
        const payback = monthlySavings <= 0 ? 0 : cost / monthlySavings;

        // 4. Actualizar Resultados
        displays.savings.textContent =
          Math.round(annualSavings).toLocaleString() + " ‚Ç¨";
        displays.roi.textContent = Math.round(roi) + " %";
        displays.payback.textContent =
          payback <= 0 ? "0 Meses" : (payback < 1 ? "< 1 Mes" : payback.toFixed(1) + " Meses");

        // 5. Actualizar Gr√°fico
        const chartData = [];
        let balance = -cost; // Empieza en negativo (inversi√≥n)
        // Solo calcular hasta 12 meses
        chartData.push(-cost); 
        for (let i = 2; i <= 12; i += 2) {
            balance += monthlySavings * 2;
            chartData.push(balance);
        }

        myChart.data.datasets[0].data = chartData;
        myChart.update();
      }
      
      // --- VALIDACI√ìN DE EMAIL ---
      function isValidEmail(email) {
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return re.test(String(email).toLowerCase());
      }

      // --- FUNCI√ìN DE DESBLOQUEO (ENV√çO EMAIL) ---
      async function unlockResults() {
        const email = clientEmailInput.value;
        
        if (!isValidEmail(email)) {
            emailError.classList.remove('hidden');
            clientEmailInput.classList.add('border-red-500');
            return;
        }
        
        emailError.classList.add('hidden');
        clientEmailInput.classList.remove('border-red-500');

        // Estado Cargando
        const originalText = btnUnlock.innerText;
        btnUnlock.disabled = true;
        btnUnlock.innerHTML = `
            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Procesando...
        `;
        
        // ENV√çO DE EMAIL (AJAX)
        try {
            await fetch("https://formsubmit.co/ajax/roicalculatorai@gmail.com", {
                method: "POST",
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    _subject: "Nuevo Lead - SAP Value Bridge",
                    _captcha: "false",
                    timestamp: new Date().toLocaleString(),
                    message: `Nuevo usuario desbloque√≥ la calculadora ROI con el email: ${email}`
                })
            });
            console.log("Email enviado correctamente");
        } catch (error) {
            console.error("Error enviando email:", error);
            // Seguimos adelante aunque falle el email para no bloquear al usuario
        }

        // --- DESBLOQUEO UI ---
        userEmail = email; // Guardamos el email para usarlo en el feedback
        isUnlocked = true;
        
        // Ocultar Overlay
        emailOverlay.style.display = 'none';
        
        // Mostrar contenido
        resultsContent.classList.remove('blur-content');
        resultsContent.classList.add('content-visible');
        
        // Calcular
        calculate(); 
        inputs.users.focus();
      }

      // --- FUNCI√ìN DE FEEDBACK ---
      async function sendFeedback(type) {
          // 1. Cambiar estado UI a "Enviando"
          document.getElementById('feedbackButtons').classList.add('hidden');
          document.getElementById('feedbackSending').classList.remove('hidden');

          // 2. Recoger datos actuales
          const currentRoi = displays.roi.textContent;
          const currentSavings = displays.savings.textContent;

          // 3. Enviar a formsubmit
          try {
              await fetch("https://formsubmit.co/ajax/roicalculatorai@gmail.com", {
                  method: "POST",
                  headers: { 
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                  },
                  body: JSON.stringify({
                      email: userEmail,
                      _subject: `Nuevo Feedback: ${type === 'like' ? 'LIKE üëç' : 'DISLIKE üëé'}`,
                      _captcha: "false",
                      feedbackType: type,
                      roiCalculated: currentRoi,
                      savingsCalculated: currentSavings,
                      message: `El usuario ${userEmail} ha dado un ${type.toUpperCase()} a la calculadora.`
                  })
              });
          } catch (error) {
              console.error("Error enviando feedback:", error);
          }

          // 4. Cambiar estado UI a "Enviado"
          document.getElementById('feedbackSending').classList.add('hidden');
          document.getElementById('feedbackSent').classList.remove('hidden');
      }

      // --- EVENT LISTENERS ---
      Object.values(inputs).forEach((input) => {
        input.addEventListener("input", calculate);
      });

      // C√°lculo inicial (solo visualizaci√≥n de sliders)
      calculate(); 
    </script>
  </body>
</html>